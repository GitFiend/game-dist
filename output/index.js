(()=>{"use strict";var t={2:(t,e,s)=>{t.exports=s.p+"output/e75282d54206d01c06e2.png"}},e={};function s(n){var o=e[n];if(void 0!==o)return o.exports;var i=e[n]={exports:{}};return t[n](i,i.exports,s),i.exports}s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),(()=>{var t;s.g.importScripts&&(t=s.g.location+"");var e=s.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var n=e.getElementsByTagName("script");n.length&&(t=n[n.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=t+"../"})(),(()=>{var t;!function(t){t[t.computed=0]="computed",t[t.autoRun=1]="autoRun",t[t.reaction=2]="reaction",t[t.component=3]="component"}(t||(t={}));class e{run(){null!==this._ref.current&&(r.pushResponder(this),this.f(),r.popResponder())}constructor(e){this.f=e,this.responderType=t.autoRun,this.ordered=!1,this._ref={current:this},this.end=()=>{this._ref.current=null},this.run()}}function n(t){return new e(t).end}class o{run(){if(null===this._ref.current)return;r.pushResponder(this);const t=this.calc();r.popResponder(),this.value!==t&&(this.value=t,this.f(t))}constructor(e,s){this.calc=e,this.f=s,this.responderType=t.reaction,this.ordered=!1,this._ref={current:this},this.end=()=>{this._ref.current=null},r.pushResponder(this),this.value=this.calc(),r.popResponder()}}function i(t,e){return new o(t,e).end}const r=new class{pushResponder(t){this.responderStack.push(t)}popResponder(){this.responderStack.pop()}getCurrentResponder(){const t=this.responderStack.length;return t>0?this.responderStack[t-1]:null}queueNotifierIfInAction(t){return null!==this.actionStack&&(this.actionStack.add(t),!0)}insideNonComputedResponder(){return this.responderStack.some((e=>e.responderType!==t.computed))}runComputedNowIfInActionStack(t){return!0===this.actionStack?.computeds.delete(t)&&(t.current?.run(),!0)}startAction(){this.actionDepth++,null===this.actionStack?this.actionStack=new l(this.getCurrentResponder()):this.actionStack.runningResponder=this.getCurrentResponder()}endAction(){if(this.actionDepth--,0===this.actionDepth&&null!==this.actionStack){const t=this.actionStack;this.actionStack=null,t.run()}}constructor(){this.responderStack=[],this.actionStack=null,this.actionDepth=0}};class c{static insert(t,e){const{order:s}=e;for(let n=0;n<t.length;n++){const o=t[n];if(s<o.order)return t.splice(n,0,e),n;if(s===o.order)return t[n]=e,n}return t.push(e),t.length-1}static remove(t,e){const{order:s}=e;for(let e=0;e<t.length;e++)t[e].order===s&&t.splice(e,1)}}function h(t){const{inserted:e,siblings:s,element:n}=t;let o=null;for(let t=e.length-1;t>=0;t--){const i=e[t];null===o?s.has(i.element)||(n.insertBefore(i.element,null),s.set(i.element,null)):s.has(o.element)&&s.get(o.element)!==i.element&&(n.insertBefore(i.element,o.element),s.set(o.element,i.element),s.has(i.element)||s.set(i.element,null)),o=i}}class a{static key(t,e){return t+String.fromCharCode(e+48)}static insert(t,e){const{inserted:s}=t,{order:n,key:o}=e;for(let i=s.length-1;i>=0;i--){const r=s[i],c=s[i+1];if(n>=r.order)return void(o!==r.key&&(null!=c?(s.splice(i+1,0,e),u.insertsStack.add(t)):(u.insertsStack.add(t),s.push(e))))}s.unshift(e),u.insertsStack.add(t)}static move(t,e){const{inserted:s}=t,{key:n}=e,o=s.findIndex((t=>t.key===n));o>=0&&s.splice(o,1),this.insert(t,e)}static remove(t,e){const{inserted:s,siblings:n}=t,{key:o}=e,i=s.findIndex((t=>t.key===o));if(i>=0){const[t]=s.splice(i,1);n.delete(t.element),u.removeStack.add(t.element)}}}class u{static runResponders(t,e,s){for(const t of s.values())null!==t.current&&c.insert(this.components,t.current);for(const e of t)null!==e.current&&this.computeds.add(e);for(const t of e)null!==t.current&&this.reactions.add(t);this.run()}static run(){if(!this.running){for(this.running=!0;this.computeds.size>0||this.reactions.size>0;){for(;this.computeds.size>0;){const t=this.computeds.values().next().value;this.computeds.delete(t),t.current?.run()}for(;this.reactions.size>0;){const t=this.reactions.values().next().value;this.reactions.delete(t),t.current?.run()}}for(;this.components.length>0;)this.components.shift()?.run();for(const t of this.removeStack)t.remove();this.removeStack.clear();for(const t of this.insertsStack)h(t);for(this.insertsStack.clear();this.componentDidMountStack.length>0;)this.componentDidMountStack.shift()?.current?.componentDidMount();for(;this.componentDidUpdateStack.length>0;)this.componentDidUpdateStack.shift()?.current?.componentDidUpdate();this.running=!1,this.empty()||this.run()}}static empty(){return 0===this.computeds.size&&0===this.reactions.size&&0===this.components.length&&0===this.insertsStack.size&&0===this.removeStack.size&&0===this.componentDidMountStack.length&&0===this.componentDidUpdateStack.length}}u.computeds=new Set,u.reactions=new Set,u.components=[],u.running=!1,u.insertsStack=new Set,u.removeStack=new Set,u.componentDidMountStack=[],u.componentDidUpdateStack=[];class l{add(t){for(const e of t.computeds)e.current!==this.runningResponder&&this.computeds.add(e);for(const e of t.reactions)e.current!==this.runningResponder&&this.reactions.add(e);for(const e of t.components.values())e.current&&e.current!==this.runningResponder&&this.components.set(e.current?.order,e);t.computeds.size>0&&t.computeds.clear(),t.reactions.size>0&&t.reactions.clear(),t.components.size>0&&t.components.clear()}run(){u.runResponders(this.computeds,this.reactions,this.components)}constructor(t){this.runningResponder=t,this.computeds=new Set,this.reactions=new Set,this.components=new Map}}var d,p,m;function f(t){return e=>void 0===e?{elementType:p.host,_type:t,namespace:d.html,props:{}}:"string"==typeof e?{elementType:p.host,_type:t,namespace:d.html,props:{children:[e]}}:{elementType:p.host,_type:t,namespace:d.html,props:e}}function g(t,e,s){const n=Object.keys(s);for(const o of n)void 0!==s[o]&&v(t,e,o,s[o])}function v(t,e,s,n){switch(s){case"key":case"children":break;case"className":t.setAttribute("class",n);break;case"value":case"style":t[s]=n;break;case"ref":n.current=t;break;default:if(e===d.svg&&function(t,e,s){switch(e){case"strokeWidth":return t.setAttribute("stroke-width",s),!0;case"strokeLinejoin":return t.setAttribute("stroke-linejoin",s),!0}return!1}(t,s,n))break;s.startsWith("on")?t.addEventListener(s.slice(2),n):"boolean"==typeof n?n?t.setAttribute(s,""):t.removeAttribute(s):t.setAttribute(s,n)}}function w(t,e,s){e.startsWith("on")?t.removeEventListener(e.slice(2),s):"className"===e?t.removeAttribute("class"):"ref"===e?s.current=null:t.removeAttribute(e)}!function(t){t[t.html=0]="html",t[t.svg=1]="svg"}(d||(d={})),function(t){t[t.host=0]="host",t[t.custom=1]="custom"}(p||(p={})),function(t){t[t.host=0]="host",t[t.custom=1]="custom",t[t.text=2]="text"}(m||(m={}));class y{renderSubtrees(t){this.subComponents=M.subtrees(this,this,t,this.subComponents)}insertChild(t){a.insert(this,t)}moveChild(t){a.move(this,t)}removeChild(t){a.remove(this,t)}remove(){if(this.parentHost.removeChild(this),this.subComponents.size>0){for(const t of this.subComponents.values())t.remove();this.subComponents.clear()}this.inserted.length>0&&(this.inserted=[])}constructor(t,e,s,n,o,i){this.tag=t,this.namespace=e,this.props=s,this.parentHost=n,this.index=i,this._type=m.host,this.subComponents=new Map,this.inserted=[],this.siblings=new WeakMap,this.order=a.key(o.order,i),this.key=this.props.key??o.key+i,e===d.svg?this.element=document.createElementNS("http://www.w3.org/2000/svg",t):this.element=document.createElement(t),g(this.element,e,s),this.renderSubtrees(s.children??[]),n.insertChild(this)}}class b{remove(){this.parentHost.removeChild(this)}constructor(t,e,s,n){this.text=t,this.parentHost=e,this.index=n,this._type=m.text;const o=a.key(s.order,n);this.key=s.key+n,this.order=o,this.element=document.createTextNode(t),e.insertChild(this)}}class k{update(){const t=this.render();this.subComponents=M.subtrees(this.parentHost,this,Array.isArray(t)?t:[t],this.subComponents)}updateWithNewProps(t){(function(t,e){const s=Object.keys(t),n=Object.keys(e);if(s.length!==n.length)return!1;for(const n of s)if(t[n]!==e[n])return!1;return!0})(this.props,t)||(this.props=t,this.update(),u.componentDidUpdateStack.push(this._ref))}componentDidMount(){}componentDidUpdate(){}componentWillUnmount(){}mount(){this.update(),u.componentDidMountStack.push(this._ref)}remove(){this.componentWillUnmount();for(const t of this.subComponents.values())t.remove();this.subComponents.clear(),this.removed=!0}static $(t){return{_type:this,elementType:p.custom,props:t}}constructor(t,e,s,n){this.parentHost=e,this.index=n,this._type=m.custom,this.subComponents=new Map,this._ref={current:this},this.forceUpdate=()=>{this.removed||this.update()},this.removed=!1,this.props=t,this.order=a.key(s.order,n),this.key=this.props.key??s.key+n}}function S(t,e,s,n,o){const i=new t(e,s,n,o);return i.mount(),i}class x{render(t){this.component=M.tree(t,this.component,this,this,0),u.run()}insertChild(t){a.insert(this,t)}removeChild(t){a.remove(this,t)}moveChild(t){a.move(this,t)}remove(){this.component?.remove(),this.component=null}get html(){return this.element.innerHTML}constructor(t){this.element=t,this.component=null,this.order="1",this.key="root",this.inserted=[],this.siblings=new WeakMap}}const C=new class{render(t,e){this.target!==e?(this.clear(),this.rootNode=new x(e)):null===this.rootNode&&(this.rootNode=new x(e)),this.rootNode.render(t)}clear(){this.rootNode?.remove(),this.rootNode=null}constructor(){this.rootNode=null,this.target=null}};class M{static tree(t,e,s,n,o){return t.elementType===p.host?function(t,e,s,n,o){const{_type:i,namespace:r,props:c}=t;if(null===e)return new y(i,r,c,s,n,o);if(e._type===m.host&&e.tag===i){const t=a.key(n.order,o);return e.order!==t&&(e.index=o,e.order=t,s.moveChild(e)),function(t,e,s,n){null===n?g(t,e,s):function(t,e,s,n){const o=Object.keys(s),i=Object.keys(n);for(const i of o){const o=n[i],r=s[i];void 0!==r&&(void 0===o?v(t,e,i,r):o!==r&&(i.startsWith("on")&&w(t,i,o),v(t,e,i,r)))}for(const e of i){const o=n[e];void 0===s[e]&&void 0!==o&&w(t,e,o)}}(t,e,s,n)}(e.element,r,c,e.props),e.props=c,e.renderSubtrees(c.children??[]),e}return e.remove(),new y(i,r,c,s,n,o)}(t,e,s,n,o):function(t,e,s,n,o){const{_type:i,props:r}=t;if(null===e)return S(i,r,s,n,o);if(e._type===m.custom&&e instanceof i){const t=a.key(n.order,o);if(t!==e.order){e.index=o,e.order=t;for(const t of e.subComponents.values()){const n=a.key(e.order,t.index);if(t.order!==n)switch(t.order=n,t._type){case m.host:case m.text:s.moveChild(t);break;case m.custom:t.update()}}}return e.updateWithNewProps(r),e}return e.remove(),S(i,r,s,n,o)}(t,e,s,n,o)}static subtrees(t,e,s,n){const o=new Map;for(let i=s.length-1;i>=0;i--){const r=s[i];null!==r&&this.subtree(t,e,r,n,o,i)}for(const t of n.values())t.remove();return o}static subtree(t,e,s,n,o,i){if("string"==typeof s){const r=i.toString(),c=function(t,e,s,n,o){if(null===e)return new b(t,s,n,o);if(e._type===m.text){const i=e.order,r=a.key(n.order,o);return i!==r&&(e.index=o,e.order=r,s.moveChild(e)),e.text===t||(e.element.nodeValue=t,e.text=t),e}return e.remove(),new b(t,s,n,o)}(s,n.get(r)??null,t,e,i);return n.delete(r),o.set(r,c),c}const r=s.props.key??i.toString(),c=this.tree(s,n.get(r)??null,t,e,i);return n.delete(r),o.set(r,c),c}}f("h1"),f("h2"),f("h3");const R=f("div"),A=(f("header"),f("footer"),f("span"),f("a"),f("p"),f("b"),f("br"),f("img"),f("ul"),f("li"),f("ol"),f("video"),f("source"),f("i"),f("button")),j=f("canvas");function $(e,s){switch(s.responderType){case t.computed:e.computeds.add(s._ref);break;case t.autoRun:case t.reaction:e.reactions.add(s._ref);break;case t.component:const n=s;e.components.set(n.order,n._ref)}}function _(t){const{computeds:e,reactions:s,components:n}=t;(e.size>0||s.size>0||n.size>0)&&(r.queueNotifierIfInAction(t)||(t.computeds=new Set,t.reactions=new Set,t.components=new Map,u.runResponders(e,s,n)))}function z({reactions:t,components:e,computeds:s}){for(const e of t)if(null!==e.current)return!0;for(const t of e.values())if(null!==t.current)return!0;for(const t of s)if(null!==t.current&&z(t.current))return!0;return!1}f("form"),f("input"),f("datalist"),f("option"),f("textarea"),f("label"),f("table"),f("tr"),f("td"),f("th");class D{get(t){return null!==t&&this.addCallingResponderToOurList(t),this.value}set(t){this.value!==t&&(this.value=t,this.hasActiveResponders()?_(this):this.deactivateAndClear())}hasActiveResponders(){return z(this)}deactivateAndClear(){const{computeds:t,reactions:e,components:s}=this;e.clear(),s.clear();for(const e of t)null!==e.current&&e.current.deactivateAndClear();t.clear()}addCallingResponderToOurList(t){$(this,t)}constructor(t,e){this.value=t,this.name=e,this.computeds=new Set,this.reactions=new Set,this.components=new Map}}class O{run(){this.hasActiveResponders()?this.runFunction(!0):null!==this._ref.current&&this.deactivateAndClear()}get(t){null!==t&&this.addCallingResponderToOurList(t);const e=null===this._ref.current,s=this.hasActiveResponders();return e?(s&&(this._ref.current=this),this.runFunction(!1)):s?r.runComputedNowIfInActionStack(this._ref):this.deactivateAndClear(),this.value}runFunction(t){r.pushResponder(this);const e=this.f();r.popResponder(),e!==this.value&&(this.value=e,t&&_(this))}addCallingResponderToOurList(t){$(this,t)}hasActiveResponders(){return z(this)}deactivateAndClear(){this._ref.current=null;const{computeds:t,reactions:e,components:s}=this;e.clear(),s.clear();for(const e of t)null!==e.current&&e.current.deactivateAndClear();t.clear()}isMarkedActive(){return null!==this._ref.current}constructor(e,s){this.f=e,this.name=s,this.responderType=t.computed,this.ordered=!1,this.computeds=new Set,this.reactions=new Set,this.components=new Map,this._ref={current:null}}}function T(t,e){for(const e in t)if(e.startsWith("$")){const s=`__${e}`,n=t[e];n instanceof Function||Object.defineProperties(t,{[s]:{value:new D(n,s)},[e]:{get(){return this[s].get(r.getCurrentResponder())},set(t){this[s].set(t)}}})}const s=Object.entries(Object.getOwnPropertyDescriptors(e.prototype));for(const[e,n]of s)if(e.startsWith("$")&&void 0!==n.get){const s=`__${e}`;Object.defineProperties(t,{[s]:{value:new O(n.get.bind(t),s)},[e]:{get(){return this[s].get(r.getCurrentResponder())}}})}}class N{connect(){T(this,this.constructor)}$AutoRun(t){this.disposers.push(n(t))}$Reaction(t,e){this.disposers.push(i(t,e))}disposeReactions(){for(const t of this.disposers)t();this.disposers=[]}constructor(){this.disposers=[]}}class P extends k{mount(){T(this,this.constructor),this.update(),u.componentDidMountStack.push(this._ref)}run(){null!==this._ref.current&&(this.update(),u.componentDidUpdateStack.push(this._ref))}update(){r.pushResponder(this),super.update(),r.popResponder()}remove(){this._ref.current=null;for(const t of this.disposers)t();this.disposers=[],super.remove()}$AutoRun(t){this.disposers.push(n(t))}$Reaction(t,e){this.disposers.push(i(t,e))}constructor(...e){super(...e),this.responderType=t.component,this.ordered=!0,this.disposers=[]}}function L(t,...e){if(1===t.length)return t[0];let s="";for(let n=0;n<t.length;n++)e[n]&&(s+=t[n]);return s.trim()}function I(t){return e=>({elementType:p.host,_type:t,namespace:d.svg,props:e})}var F;I("svg"),I("polyline"),I("polygon"),I("circle"),I("title"),I("g");class U extends P{render(){const{$size:{width:t,height:e}}=this.props.uiStore;return j({ref:this.ref,className:L`Stage`,width:t,height:e})}componentDidMount(){const{current:t}=this.ref;t&&(this.context=t.getContext("2d"),this.gameLoop()),addEventListener("resize",(()=>{const{innerWidth:t,innerHeight:e}=window,{uiStore:s,store:{camera:n}}=this.props;s.$size={width:t,height:e},n.width=t,n.height=e}))}constructor(...t){super(...t),this.ref={current:null},this.context=null,this.timeOfLastFrame=Date.now(),this.gameLoop=()=>{this.gameLoop.name;const{context:t}=this;if(!t)return;const e=Date.now(),{gameObjects:s,gameObjects:{stats:n},camera:o}=this.props.store,i=e-this.timeOfLastFrame;s.update(i,o),o.update(),s.draw(t,o),requestAnimationFrame(this.gameLoop),n.addFrameDuration(Date.now()-e),this.timeOfLastFrame=e,this.gameLoop.name}}}class W extends P{render(){const{$showingConverse:t,$prompt:e}=this;return R({className:"Converse",children:[A({children:[t?"Hide hud":"Show hud"],className:"Converse-showButton",onclick:this.onClickShow}),t?this.drawConverseControls(e[this.$currentPrompt]):null]})}drawConverseControls(t){return R({className:"Converse-controls",children:[R({children:[t.npcText]}),R({className:L`Converse-options`,children:t.playerResponses.map(this.drawOption)})]})}constructor(...t){super(...t),this.$showingConverse=!1,this.$currentPrompt=0,this.$prompt=[{npcText:"0: Are you feeling lucky?",playerResponses:[{text:"yes",next:1},{text:"no",next:1},{text:"leave me alone",next:0}]},{npcText:"That will do you little good",playerResponses:[{text:"yes",next:0},{text:"no",next:0},{text:"leave me alone",next:0}]}],this.drawOption=t=>A({children:[t.text],onclick:()=>{this.$currentPrompt=t.next}}),this.onClickShow=()=>{this.$showingConverse=!this.$showingConverse}}}class E extends P{render(){return R({className:L`Hud`,children:[this.drawShootButton(),W.$({})],oncontextmenu:this.onContextMenu})}drawShootButton(){return this.props.uiStore.touchDevice?A({className:L`Hud-shootButton`,onclick:this.onClickShoot,children:["Shoot"]}):null}constructor(...t){super(...t),this.onClickShoot=t=>{t.preventDefault(),t.stopPropagation(),this.props.store.gameObjects.player.shoot()},this.onContextMenu=t=>{t.preventDefault()}}}class B extends N{constructor(){super(),this.touchDevice="ontouchstart"in window||navigator.maxTouchPoints>0,this.$size={width:window.innerWidth,height:window.innerHeight},super.connect()}}!function(t){function e(t,e){return Math.sqrt(t**2+e**2)}t.empty=[0,0],t.normalise=function(t){const[e,s]=t,n=Math.sqrt(e**2+s**2);if(0===n)return t;const o=1/n;return[e*o,s*o]},t.limitMagnitude=function(t,e){const[s,n]=t,o=Math.sqrt(s**2+n**2);if(o<e)return t;const i=e/o;return[s*i,n*i]},t.magnitude=e,t.add=function(t,e){return[t[0]+e[0],t[1]+e[1]]},t.subtract=function(t,e){return[t[0]-e[0],t[1]-e[1]]},t.reverse=function([t,e]){return[-t,-e]},t.angle=function([t,e]){return Math.atan2(e,t)+90*Math.PI/180},t.scale=function([t,e],s){return[t*s,e*s]},t.rotate=function([t,e],s){const n=Math.sin(s),o=Math.cos(s);return[o*t-n*e,n*t+o*e]},t.distance=function(t,s){return e(s[0]-t[0],s[1]-t[1])}}(F||(F={}));class H{nextInt(){return this.seed=48271*this.seed%2147483647}next(){return(this.nextInt()-1)/2147483646}constructor(t){this.seed=t,(this.seed=(0|t)%2147483647)<=0&&(this.seed+=2147483646)}}const q=new H(0);function V(t,e){return[J(t[0]-e[0]),J(t[1]+e[1])]}function J(t){return t<0?t%1+1:t%1}var X;!function(t){t[t.weapon=0]="weapon",t[t.player=1]="player",t[t.object=2]="object",t[t.visual=3]="visual"}(X||(X={}));let Y=0;function G(){const t=Y;return Y++,t}const K=1e8;function Q(t){return[Math.floor(t/K),t%K]}class Z{draw(t,e){const{width:s,height:n}=e;this.drawBackground(t,s,n);const{id:o}=this.store.gameObjects.player,i=this.store.movers.get(o);i&&this.drawStars(t,s,n,i)}drawBackground(t,e,s){t.fillStyle="rgb(0, 0, 0)",t.fillRect(0,0,e,s)}drawStars(t,e,s,n){const{position:[o,i]}=n,r=o/1e4%1e4,c=i/1e4%1e4;for(const{v:[n,o],size:i,colour:h}of function(t,e){return t.map((({v:t,size:s,colour:n})=>({v:V(t,e),size:s,colour:n})))}(this.stars,[r,-c])){const r=n*e,c=o*s;t.beginPath(),t.fillStyle=h,t.arc(r,c,5*i,0,2*Math.PI),t.fill()}}update(t,e){}constructor(t){this.store=t,this.id=G(),this.stars=function(t){const e=[],s=new H(0),n=()=>s.next();for(let s=0;s<t;s++)e.push({v:[n(),n()],size:n(),colour:`hsl(${Math.round(255*n())}, ${Math.round(20*n())}%, ${Math.round(100*n())}%)`});return e}(60),this.type=X.visual}}class tt{get center(){const{position:[t,e],size:[s,n]}=this;return[t+s/2,e+n/2]}get radius(){const{size:[t,e]}=this;return(t+e)/4}constructor(t=F.empty,e=F.empty,s=F.empty,n=F.empty,o=F.empty,i=0,r=1,c=10,h=!0){this.position=t,this.size=e,this.direction=s,this.velocity=n,this.thrust=o,this.rotation=i,this.mass=r,this.maxVelocity=c,this.visible=h,this.id=G()}}function et(t,e,s){if(0!==t.rotation){const s=e/1e3*t.rotation;t.direction=F.normalise(F.rotate(t.direction,s))}0===t.thrust[0]&&0===t.thrust[1]||(t.velocity=F.limitMagnitude(F.add(t.velocity,F.scale(t.thrust,e/100)),t.maxVelocity)),t.position=F.add(t.position,t.velocity),t.visible=function([t,e],[s,n],o){const{width:i,height:r,shift:[c,h]}=o,a=300;return t>-c-a&&t<-c+i+a&&e>-h-a&&e<-h+r+a}(t.position,t.size,s)}class st{update(t,e){this.thrust=e;for(const e of this.particles)e.position[1]=(e.position[1]+.05*t)%this.height}draw(t,e){const{parent:{position:[s,n]},pos:[o,i],thrust:r}=this,{shift:[c,h]}=e;for(const e of this.particles){let[a,u]=e.position;u*=r,t.fillStyle=`rgba(256, 256, 150, ${1/(.5*u)})`;let l=u>4?a/(u/4):a;t.fillRect(s+c+o+l,n+h+i+u,2*(.1+r),2*(.1+r))}}constructor(t,e,s,n){this.pos=t,this.width=e,this.height=s,this.parent=n,this.particles=[],this.thrust=1;const o=new H(0);for(let t=0;t<40;t++){const t=o.next()*s,n=(o.next()-.5)*e;this.particles.push({colour:"#ffff7755",position:[n,t]})}}}const nt=new class{enable(t){this.enabled=t}draw(t,e,s){if(!this.enabled)return;const{shift:[n,o]}=s,{position:[i,r],size:[c,h],id:a}=e,u=i+n,l=r+o;t.lineWidth=1,t.strokeStyle="yellow",t.font="11px monospace",t.fillStyle="yellow",t.fillText(a.toString(),u,l-1),t.beginPath();const d=c/2,p=h/2;t.arc(u+d,l+p,(d+p)/2,0,2*Math.PI),t.stroke()}constructor(){this.enabled=!1}};class ot{draw(t,e){const s=this.store.movers.get(this.id);if(!s)return;const{position:[n,o]}=s,{shift:[i,r]}=e;t.fillStyle="#ffc916",t.beginPath(),t.arc(n+i,o+r,4/1.3,0,2*Math.PI),t.fill()}update(t,e){const s=this.store.movers.get(this.id);s&&(s.visible||this.store.gameObjects.delete(this.id))}hit(t){t.type===X.object&&(this.store.gameObjects.delete(t.id),this.store.gameObjects.delete(this.id))}constructor(t,e){this.store=t,this.type=X.weapon;const{movers:s,gameObjects:{player:{m:n}}}=t;let o=n.center;if("left"===e){const t=F.angle(n.direction);o=F.add(o,F.rotate([-10,-6],t))}else{const t=F.angle(n.direction);o=F.add(o,F.rotate([10,-6],t))}const i=new tt(o,[4,4],n.direction,F.add(n.velocity,F.scale(n.direction,10)),F.empty,0,1,100);this.id=i.id,s.add(i)}}class it{update(t){const{controls:{thrust:e,rotation:s,back:n}}=this.store;this.lastShot+=t,this.shooting&&this.lastShot>this.timeBetweenShots&&this.shoot();const{movers:o}=this.store,i=o.get(this.id);i&&(i.rotation=s,e>0?(this.thruster.update(t,e),i.thrust=F.scale(i.direction,e/1.5)):i.thrust=F.empty,n&&(i.velocity=F.empty))}draw(t,e){const{m:s}=this;if(!s)return;const{position:[n,o],size:[i,r]}=s,{shift:[c,h]}=e,a=F.angle(s.direction),u=i/2,l=r/2,d=c+n,p=h+o;t.save(),t.translate(d+u,p+l),t.rotate(a),t.translate(-d-u,-p-l),t.drawImage(this.shipImage,d,p,i,r),this.store.controls.thrust>0&&this.thruster.draw(t,e),t.restore(),nt.draw(t,s,e)}resetPosition(){const{movers:t}=this.store,e=t.get(this.id);e&&(e.position=F.empty,e.velocity=F.empty)}get m(){const{movers:t}=this.store;return t.get(this.id)}startShooting(){this.shooting=!0}stopShooting(){this.shooting=!1}shoot(){const t=new ot(this.store,"left");this.store.gameObjects.objects.set(t.id,t);const e=new ot(this.store,"right");this.store.gameObjects.objects.set(e.id,e),this.lastShot=0}constructor(t){this.store=t,this.type=X.player,this.shipImage=document.createElement("img"),this.shooting=!1,this.lastShot=0,this.timeBetweenShots=100,this.shipImage.src=s(2);const{movers:e}=t,n=new tt(F.empty,[40,40],[0,-1]);n.mass=5,this.id=n.id,e.add(n),this.thruster=new st(F.add(n.position,[19,38]),8,10,n)}}class rt{calcStats(){const{movers:t,gameObjects:{player:{id:e}}}=this.store,s=t.get(e);if(!s)return;const{position:n,direction:o,velocity:i}=s,r=t=>t.toPrecision(4);return[`${this.getFps()} fps (${this.getAvFrame().toPrecision(2)}ms/f)`,`pos (${r(n[0])}, ${r(n[1])})`,`dir (${o[0].toFixed(2)}, ${o[1].toFixed(2)})`,`vel (${i?.[0].toFixed(1)??0}, ${i?.[1].toFixed(1)??0})`]}draw(t,e){t.font="14px monospace",t.fillStyle="yellow",this.calcStats()?.forEach(((e,s)=>{t.fillText(e,8,22*(s+1))}))}update(t){this.fps.push(t),this.fps.length>10&&this.fps.shift()}getFps(){const t=this.fps.reduce(((t,e)=>t+e),0)/this.fps.length;return Math.min(Math.round(1e3/t),60)}addFrameDuration(t){this.frameDurations.push(t),this.frameDurations.length>100&&this.frameDurations.shift()}getAvFrame(){return this.frameDurations.reduce(((t,e)=>t+e),0)/this.frameDurations.length}constructor(t){this.store=t,this.id=G(),this.type=X.visual,this.fps=[],this.frameDurations=[]}}class ct{generatePoints(){const{size:t}=this;for(let e=0;e<13;e++){const s=q.next()-.5,n=q.next()-.5,o=F.scale(F.rotate([.25*s,1+.25*n],2*Math.PI/13*e),t/2.2);o[0]+=.03,o[1]+=.03,this.points.push(o)}}drawToCanvasAndCreateBitMap(){if(!this.cache)return;const{size:t,cache:e,cache:{ctx:s}}=this;if(!s)return;const n=t/2;this.drawAsteroid(s,n,n),e.cached=!0}drawAsteroid(t,e,s){t.beginPath();const n=t.createRadialGradient(e,s,this.size/20,e,s,this.size/2);n.addColorStop(0,"#7e7e7e"),n.addColorStop(.9,"#5d5d5d"),t.fillStyle=n,t.strokeStyle="#5d5d5d",t.lineWidth=4;const o=this.points[0];t.moveTo(e+o[0],s+o[1]);for(const n of this.points)t.lineTo(e+n[0],s+n[1]);t.lineTo(e+o[0],s+o[1]),t.stroke(),t.fill()}drawCached(t,e,s){if(this.cache&&(this.cache.cached||this.drawToCanvasAndCreateBitMap(),this.cache.cached)){const{position:[n,o]}=s,{shift:[i,r]}=e;t.drawImage(this.cache.canvas,n+i,o+r),nt.draw(t,s,e)}}draw(t,e){const{movers:s}=this.store,n=s.get(this.id);n&&n.visible&&this.drawUnCached(t,e,n)}drawUnCached(t,e,s){const{position:[n,o]}=s,{shift:[i,r]}=e,c=this.size/2;this.drawAsteroid(t,n+i+c,o+r+c),nt.draw(t,s,e)}update(t,e){}constructor(t,e=20,s){this.store=t,this.size=e,this.points=[],this.type=X.object,this.cache=null;const{movers:n}=t,o=new tt(s,[e,e]);o.mass=(e/15)**1.6,this.id=o.id,n.add(o),this.generatePoints()}}class ht{update(t,e){this.store.movers.update(t,e);for(const s of this.objects.values())s.update(t,e)}draw(t,e){for(const s of this.objects.values())s.draw(t,e)}delete(t){this.store.movers.delete(t),this.objects.delete(t)}constructor(t){this.store=t,this.objects=new Map,this.player=new it(this.store),this.stats=new rt(this.store);const e=new Z(t);this.objects.set(e.id,e),function(t,e){const s=9e3;for(let n=0;n<5e3;n++){const n=new ct(t,10+40*q.next(),[-s/2+q.next()*s,-s/2+q.next()*s]);e.set(n.id,n)}}(t,this.objects),this.objects.set(this.player.id,this.player),this.objects.set(this.stats.id,this.stats)}}class at{constructor(t,e){this.store=t,this.controls=e,this.startPos=F.empty,this.onMove=t=>{if(t.currentTarget instanceof Window){const{clientX:e,clientY:s}=t,[n,o]=this.startPos,i=e-n,r=s-o,c=F.magnitude(i,r);this.controls.thrust=c>15?Math.min(.9,(c-15)/50):0,c>5&&(this.store.gameObjects.player.m.direction=F.normalise([i,r]))}},this.onUp=()=>{removeEventListener("pointermove",this.onMove),this.controls.rotation=0,this.controls.thrust=0},addEventListener("pointerdown",(t=>{if(t.currentTarget instanceof Window){const{clientX:e,clientY:s}=t;this.startPos=[e,s],addEventListener("pointermove",this.onMove),addEventListener("pointerup",this.onUp,{once:!0}),addEventListener("pointerout",this.onUp,{once:!0})}}))}}class ut{constructor(t){this.store=t,this.thrust=0,this.back=!1,this.rotation=0,new at(t,this),addEventListener("keydown",(t=>{switch(t.key){case"p":this.store.paused=!this.store.paused;break;case"b":nt.enable(!nt.enabled);break;case"w":case"ArrowUp":this.thrust=.9;break;case"s":case"ArrowDown":this.back=!0;break;case"a":case"ArrowLeft":this.rotation=-4;break;case"d":case"ArrowRight":this.rotation=4;break;case" ":this.store.gameObjects.player.startShooting()}})),addEventListener("keyup",(t=>{switch(t.key){case"r":this.store.gameObjects.player.resetPosition();break;case"p":break;case"w":case"ArrowUp":this.thrust=0;break;case"s":case"ArrowDown":this.back=!1;break;case"a":case"ArrowLeft":case"d":case"ArrowRight":this.rotation=0;break;case" ":this.store.gameObjects.player.stopShooting()}}))}}function lt(t,e,s){const n=s.get(t),o=s.get(e);if(n&&o)return F.distance(n.center,o.center)<=n.radius+o.radius}function dt(t,e,s){const n=s.get(t),o=s.get(e);if(!n||!o)return;const{center:i,velocity:r,mass:c}=n,{center:h,velocity:a,mass:u}=o,l=F.subtract(h,i),d=F.distance(h,i),p=[l[0]/d,l[1]/d],m=[r[0]-a[0],r[1]-a[1]],f=m[0]*p[0]+m[1]*p[1];if(f<0)return;const g=2*f/(c+u);n.velocity=[r[0]-g*u*p[0],r[1]-g*u*p[1]],o.velocity=[a[0]+g*c*p[0],a[1]+g*c*p[1]]}function pt(t,e,[s,n],[o,i]){pt.name;const r=function(t,e,s,n){const o=ft(t,e,10),{length:i}=o;if(0===i)return o;const r=-t;t+=r,e+=r;for(const{position:s,size:[i],id:c,visible:h}of n.values()){if(!h)continue;const n=s[0]+r;for(let s=n;s<n+i;s+=10)s>=t&&s<=e&&o[Math.floor(s/10)].push(c)}return o.length,JSON.stringify(o),o}(s,o,0,e),c=function(t,e,s,n){const o=ft(t,e,10),{length:i}=o;if(0===i)return o;const r=-t;t+=r,e+=r;for(const{position:s,size:i,id:c,visible:h}of n.values()){if(!h)continue;const n=i[1],a=s[1]+r;for(let s=a;s<a+n;s+=10)s>=t&&s<=e&&o[Math.floor(s/10)].push(c)}return o.length,JSON.stringify(o),o}(n,i,0,e),h=function(t,e){t=t.filter((t=>t.length>1)),e=e.filter((t=>t.length>1));const s=new Set;for(const e of t)for(const t of mt(e))s.add(t);const n=new Set;for(const t of e)for(const e of mt(t))s.has(e)&&n.add(e);const o=[];for(const t of n.values())o.push(Q(t));return o}(r,c);pt.name;const{gameObjects:a}=t;for(const[t,s]of h){if(!lt(t,s,e))continue;const n=a.objects.get(t),o=a.objects.get(s);n&&o&&(n.type===X.weapon?n.hit(o):o.type===X.weapon?o.hit(n):dt(t,s,e))}}function mt(t){const e=[];for(let s=0;s<t.length;s++){const n=t[s];for(let o=s+1;o<t.length;o++){const s=t[o];e.push(n*K+s)}}return e}function ft(t,e,s){const n=e-t,o=Math.ceil(n/s),i=[];for(let t=0;t<o;t++)i.push([]);return i}class gt{update(t,e){for(const s of this.map.values())et(s,t,e);const{points:[s,n]}=e;pt(e.store,this.map,s,n)}add(t){this.map.set(t.id,t)}get(t){return this.map.get(t)}delete(t){this.map.delete(t)}constructor(){this.map=new Map}}class vt{update(){const{width:t,height:e,store:s}=this,{movers:n}=s,{id:o}=this.store.gameObjects.player,i=n.get(o);if(!i)return;const{position:[r,c],size:[h,a]}=i,u=t/2,l=e/2;this.shift=[-r+u-h/2,-c+l-a/2],this.points=[[r-u,c-l],[r+u,c+l]]}constructor(t,e,s){this.store=t,this.width=e,this.height=s,this.scale=1,this.shift=F.empty,this.points=[F.empty,F.empty]}}class wt{constructor(t,e){this.paused=!1,this.movers=new gt,this.gameObjects=new ht(this),this.controls=new ut(this),this.camera=new vt(this,t,e)}}var yt,bt;yt=class extends P{render(){const{uiStore:t,store:e}=this;return R({className:L`Main`,children:[U.$({uiStore:t,store:e}),E.$({uiStore:t,store:e})]})}constructor(...t){super(...t),this.uiStore=new B,this.store=new wt(this.uiStore.$size.width,this.uiStore.$size.height)}}.$({}),bt=document.getElementById("root"),null===yt?C.clear():C.render(yt,bt)})()})();