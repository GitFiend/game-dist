(()=>{"use strict";var t={2:(t,e,s)=>{t.exports=s.p+"output/e75282d54206d01c06e2.png"}},e={};function s(i){var n=e[i];if(void 0!==n)return n.exports;var o=e[i]={exports:{}};return t[i](o,o.exports,s),o.exports}s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),(()=>{var t;s.g.importScripts&&(t=s.g.location+"");var e=s.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var i=e.getElementsByTagName("script");i.length&&(t=i[i.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=t+"../"})(),(()=>{var t;!function(t){t[t.computed=0]="computed",t[t.autoRun=1]="autoRun",t[t.reaction=2]="reaction",t[t.component=3]="component"}(t||(t={}));class e{run(){null!==this._ref.current&&(r.pushResponder(this),this.f(),r.popResponder())}constructor(e){this.f=e,this.responderType=t.autoRun,this.ordered=!1,this._ref={current:this},this.end=()=>{this._ref.current=null},this.run()}}function i(t){return new e(t).end}class n{run(){if(null===this._ref.current)return;r.pushResponder(this);const t=this.calc();r.popResponder(),this.value!==t&&(this.value=t,this.f(t))}constructor(e,s){this.calc=e,this.f=s,this.responderType=t.reaction,this.ordered=!1,this._ref={current:this},this.end=()=>{this._ref.current=null},r.pushResponder(this),this.value=this.calc(),r.popResponder()}}function o(t,e){return new n(t,e).end}const r=new class{pushResponder(t){this.responderStack.push(t)}popResponder(){this.responderStack.pop()}getCurrentResponder(){const t=this.responderStack.length;return t>0?this.responderStack[t-1]:null}queueNotifierIfInAction(t){return null!==this.actionStack&&(this.actionStack.add(t),!0)}insideNonComputedResponder(){return this.responderStack.some((e=>e.responderType!==t.computed))}runComputedNowIfInActionStack(t){return!0===this.actionStack?.computeds.delete(t)&&(t.current?.run(),!0)}startAction(){this.actionDepth++,null===this.actionStack?this.actionStack=new l(this.getCurrentResponder()):this.actionStack.runningResponder=this.getCurrentResponder()}endAction(){if(this.actionDepth--,0===this.actionDepth&&null!==this.actionStack){const t=this.actionStack;this.actionStack=null,t.run()}}constructor(){this.responderStack=[],this.actionStack=null,this.actionDepth=0}};class c{static insert(t,e){const{order:s}=e;for(let i=0;i<t.length;i++){const n=t[i];if(s<n.order)return t.splice(i,0,e),i;if(s===n.order)return t[i]=e,i}return t.push(e),t.length-1}static remove(t,e){const{order:s}=e;for(let e=0;e<t.length;e++)t[e].order===s&&t.splice(e,1)}}function h(t){const{inserted:e,siblings:s,element:i}=t;let n=null;for(let t=e.length-1;t>=0;t--){const o=e[t];null===n?s.has(o.element)||(i.insertBefore(o.element,null),s.set(o.element,null)):s.has(n.element)&&s.get(n.element)!==o.element&&(i.insertBefore(o.element,n.element),s.set(n.element,o.element),s.has(o.element)||s.set(o.element,null)),n=o}}class a{static key(t,e){return t+String.fromCharCode(e+48)}static insert(t,e){const{inserted:s}=t,{order:i,key:n}=e;for(let o=s.length-1;o>=0;o--){const r=s[o],c=s[o+1];if(i>=r.order)return void(n!==r.key&&(null!=c?(s.splice(o+1,0,e),u.insertsStack.add(t)):(u.insertsStack.add(t),s.push(e))))}s.unshift(e),u.insertsStack.add(t)}static move(t,e){const{inserted:s}=t,{key:i}=e,n=s.findIndex((t=>t.key===i));n>=0&&s.splice(n,1),this.insert(t,e)}static remove(t,e){const{inserted:s,siblings:i}=t,{key:n}=e,o=s.findIndex((t=>t.key===n));if(o>=0){const[t]=s.splice(o,1);i.delete(t.element),u.removeStack.add(t.element)}}}class u{static runResponders(t,e,s){for(const t of s.values())null!==t.current&&c.insert(this.components,t.current);for(const e of t)null!==e.current&&this.computeds.add(e);for(const t of e)null!==t.current&&this.reactions.add(t);this.run()}static run(){if(!this.running){for(this.running=!0;this.computeds.size>0||this.reactions.size>0;){for(;this.computeds.size>0;){const t=this.computeds.values().next().value;this.computeds.delete(t),t.current?.run()}for(;this.reactions.size>0;){const t=this.reactions.values().next().value;this.reactions.delete(t),t.current?.run()}}for(;this.components.length>0;)this.components.shift()?.run();for(const t of this.removeStack)t.remove();this.removeStack.clear();for(const t of this.insertsStack)h(t);for(this.insertsStack.clear();this.componentDidMountStack.length>0;)this.componentDidMountStack.shift()?.current?.componentDidMount();for(;this.componentDidUpdateStack.length>0;)this.componentDidUpdateStack.shift()?.current?.componentDidUpdate();this.running=!1,this.empty()||this.run()}}static empty(){return 0===this.computeds.size&&0===this.reactions.size&&0===this.components.length&&0===this.insertsStack.size&&0===this.removeStack.size&&0===this.componentDidMountStack.length&&0===this.componentDidUpdateStack.length}}u.computeds=new Set,u.reactions=new Set,u.components=[],u.running=!1,u.insertsStack=new Set,u.removeStack=new Set,u.componentDidMountStack=[],u.componentDidUpdateStack=[];class l{add(t){for(const e of t.computeds)e.current!==this.runningResponder&&this.computeds.add(e);for(const e of t.reactions)e.current!==this.runningResponder&&this.reactions.add(e);for(const e of t.components.values())e.current&&e.current!==this.runningResponder&&this.components.set(e.current?.order,e);t.computeds.size>0&&t.computeds.clear(),t.reactions.size>0&&t.reactions.clear(),t.components.size>0&&t.components.clear()}run(){u.runResponders(this.computeds,this.reactions,this.components)}constructor(t){this.runningResponder=t,this.computeds=new Set,this.reactions=new Set,this.components=new Map}}var d,p,m;function f(t){return e=>void 0===e?{elementType:p.host,_type:t,namespace:d.html,props:{}}:"string"==typeof e?{elementType:p.host,_type:t,namespace:d.html,props:{children:[e]}}:{elementType:p.host,_type:t,namespace:d.html,props:e}}function g(t,e,s){const i=Object.keys(s);for(const n of i)void 0!==s[n]&&v(t,e,n,s[n])}function v(t,e,s,i){switch(s){case"key":case"children":break;case"className":t.setAttribute("class",i);break;case"value":case"style":t[s]=i;break;case"ref":i.current=t;break;default:if(e===d.svg&&function(t,e,s){switch(e){case"strokeWidth":return t.setAttribute("stroke-width",s),!0;case"strokeLinejoin":return t.setAttribute("stroke-linejoin",s),!0}return!1}(t,s,i))break;s.startsWith("on")?t.addEventListener(s.slice(2),i):"boolean"==typeof i?i?t.setAttribute(s,""):t.removeAttribute(s):t.setAttribute(s,i)}}function w(t,e,s){e.startsWith("on")?t.removeEventListener(e.slice(2),s):"className"===e?t.removeAttribute("class"):"ref"===e?s.current=null:t.removeAttribute(e)}!function(t){t[t.html=0]="html",t[t.svg=1]="svg"}(d||(d={})),function(t){t[t.host=0]="host",t[t.custom=1]="custom"}(p||(p={})),function(t){t[t.host=0]="host",t[t.custom=1]="custom",t[t.text=2]="text"}(m||(m={}));class y{renderSubtrees(t){this.subComponents=M.subtrees(this,this,t,this.subComponents)}insertChild(t){a.insert(this,t)}moveChild(t){a.move(this,t)}removeChild(t){a.remove(this,t)}remove(){if(this.parentHost.removeChild(this),this.subComponents.size>0){for(const t of this.subComponents.values())t.remove();this.subComponents.clear()}this.inserted.length>0&&(this.inserted=[])}constructor(t,e,s,i,n,o){this.tag=t,this.namespace=e,this.props=s,this.parentHost=i,this.index=o,this._type=m.host,this.subComponents=new Map,this.inserted=[],this.siblings=new WeakMap,this.order=a.key(n.order,o),this.key=this.props.key??n.key+o,e===d.svg?this.element=document.createElementNS("http://www.w3.org/2000/svg",t):this.element=document.createElement(t),g(this.element,e,s),this.renderSubtrees(s.children??[]),i.insertChild(this)}}class b{remove(){this.parentHost.removeChild(this)}constructor(t,e,s,i){this.text=t,this.parentHost=e,this.index=i,this._type=m.text;const n=a.key(s.order,i);this.key=s.key+i,this.order=n,this.element=document.createTextNode(t),e.insertChild(this)}}class S{update(){const t=this.render();this.subComponents=M.subtrees(this.parentHost,this,Array.isArray(t)?t:[t],this.subComponents)}updateWithNewProps(t){(function(t,e){const s=Object.keys(t),i=Object.keys(e);if(s.length!==i.length)return!1;for(const i of s)if(t[i]!==e[i])return!1;return!0})(this.props,t)||(this.props=t,this.update(),u.componentDidUpdateStack.push(this._ref))}componentDidMount(){}componentDidUpdate(){}componentWillUnmount(){}mount(){this.update(),u.componentDidMountStack.push(this._ref)}remove(){this.componentWillUnmount();for(const t of this.subComponents.values())t.remove();this.subComponents.clear(),this.removed=!0}static $(t){return{_type:this,elementType:p.custom,props:t}}constructor(t,e,s,i){this.parentHost=e,this.index=i,this._type=m.custom,this.subComponents=new Map,this._ref={current:this},this.forceUpdate=()=>{this.removed||this.update()},this.removed=!1,this.props=t,this.order=a.key(s.order,i),this.key=this.props.key??s.key+i}}function k(t,e,s,i,n){const o=new t(e,s,i,n);return o.mount(),o}class x{render(t){this.component=M.tree(t,this.component,this,this,0),u.run()}insertChild(t){a.insert(this,t)}removeChild(t){a.remove(this,t)}moveChild(t){a.move(this,t)}remove(){this.component?.remove(),this.component=null}get html(){return this.element.innerHTML}constructor(t){this.element=t,this.component=null,this.order="1",this.key="root",this.inserted=[],this.siblings=new WeakMap}}const C=new class{render(t,e){this.target!==e?(this.clear(),this.rootNode=new x(e)):null===this.rootNode&&(this.rootNode=new x(e)),this.rootNode.render(t)}clear(){this.rootNode?.remove(),this.rootNode=null}constructor(){this.rootNode=null,this.target=null}};class M{static tree(t,e,s,i,n){return t.elementType===p.host?function(t,e,s,i,n){const{_type:o,namespace:r,props:c}=t;if(null===e)return new y(o,r,c,s,i,n);if(e._type===m.host&&e.tag===o){const t=a.key(i.order,n);return e.order!==t&&(e.index=n,e.order=t,s.moveChild(e)),function(t,e,s,i){null===i?g(t,e,s):function(t,e,s,i){const n=Object.keys(s),o=Object.keys(i);for(const o of n){const n=i[o],r=s[o];void 0!==r&&(void 0===n?v(t,e,o,r):n!==r&&(o.startsWith("on")&&w(t,o,n),v(t,e,o,r)))}for(const e of o){const n=i[e];void 0===s[e]&&void 0!==n&&w(t,e,n)}}(t,e,s,i)}(e.element,r,c,e.props),e.props=c,e.renderSubtrees(c.children??[]),e}return e.remove(),new y(o,r,c,s,i,n)}(t,e,s,i,n):function(t,e,s,i,n){const{_type:o,props:r}=t;if(null===e)return k(o,r,s,i,n);if(e._type===m.custom&&e instanceof o){const t=a.key(i.order,n);if(t!==e.order){e.index=n,e.order=t;for(const t of e.subComponents.values()){const i=a.key(e.order,t.index);if(t.order!==i)switch(t.order=i,t._type){case m.host:case m.text:s.moveChild(t);break;case m.custom:t.update()}}}return e.updateWithNewProps(r),e}return e.remove(),k(o,r,s,i,n)}(t,e,s,i,n)}static subtrees(t,e,s,i){const n=new Map;for(let o=s.length-1;o>=0;o--){const r=s[o];null!==r&&this.subtree(t,e,r,i,n,o)}for(const t of i.values())t.remove();return n}static subtree(t,e,s,i,n,o){if("string"==typeof s){const r=o.toString(),c=function(t,e,s,i,n){if(null===e)return new b(t,s,i,n);if(e._type===m.text){const o=e.order,r=a.key(i.order,n);return o!==r&&(e.index=n,e.order=r,s.moveChild(e)),e.text===t||(e.element.nodeValue=t,e.text=t),e}return e.remove(),new b(t,s,i,n)}(s,i.get(r)??null,t,e,o);return i.delete(r),n.set(r,c),c}const r=s.props.key??o.toString(),c=this.tree(s,i.get(r)??null,t,e,o);return i.delete(r),n.set(r,c),c}}f("h1"),f("h2"),f("h3");const A=f("div"),R=(f("header"),f("footer"),f("span"),f("a"),f("p"),f("b"),f("br"),f("img"),f("ul"),f("li"),f("ol"),f("video"),f("source"),f("i"),f("button")),z=f("canvas");function T(e,s){switch(s.responderType){case t.computed:e.computeds.add(s._ref);break;case t.autoRun:case t.reaction:e.reactions.add(s._ref);break;case t.component:const i=s;e.components.set(i.order,i._ref)}}function $(t){const{computeds:e,reactions:s,components:i}=t;(e.size>0||s.size>0||i.size>0)&&(r.queueNotifierIfInAction(t)||(t.computeds=new Set,t.reactions=new Set,t.components=new Map,u.runResponders(e,s,i)))}function _({reactions:t,components:e,computeds:s}){for(const e of t)if(null!==e.current)return!0;for(const t of e.values())if(null!==t.current)return!0;for(const t of s)if(null!==t.current&&_(t.current))return!0;return!1}f("form"),f("input"),f("datalist"),f("option"),f("textarea"),f("label"),f("table"),f("tr"),f("td"),f("th");class j{get(t){return null!==t&&this.addCallingResponderToOurList(t),this.value}set(t){this.value!==t&&(this.value=t,this.hasActiveResponders()?$(this):this.deactivateAndClear())}hasActiveResponders(){return _(this)}deactivateAndClear(){const{computeds:t,reactions:e,components:s}=this;e.clear(),s.clear();for(const e of t)null!==e.current&&e.current.deactivateAndClear();t.clear()}addCallingResponderToOurList(t){T(this,t)}constructor(t,e){this.value=t,this.name=e,this.computeds=new Set,this.reactions=new Set,this.components=new Map}}class P{run(){this.hasActiveResponders()?this.runFunction(!0):null!==this._ref.current&&this.deactivateAndClear()}get(t){null!==t&&this.addCallingResponderToOurList(t);const e=null===this._ref.current,s=this.hasActiveResponders();return e?(s&&(this._ref.current=this),this.runFunction(!1)):s?r.runComputedNowIfInActionStack(this._ref):this.deactivateAndClear(),this.value}runFunction(t){r.pushResponder(this);const e=this.f();r.popResponder(),e!==this.value&&(this.value=e,t&&$(this))}addCallingResponderToOurList(t){T(this,t)}hasActiveResponders(){return _(this)}deactivateAndClear(){this._ref.current=null;const{computeds:t,reactions:e,components:s}=this;e.clear(),s.clear();for(const e of t)null!==e.current&&e.current.deactivateAndClear();t.clear()}isMarkedActive(){return null!==this._ref.current}constructor(e,s){this.f=e,this.name=s,this.responderType=t.computed,this.ordered=!1,this.computeds=new Set,this.reactions=new Set,this.components=new Map,this._ref={current:null}}}function D(t,e){for(const e in t)if(e.startsWith("$")){const s=`__${e}`,i=t[e];i instanceof Function||Object.defineProperties(t,{[s]:{value:new j(i,s)},[e]:{get(){return this[s].get(r.getCurrentResponder())},set(t){this[s].set(t)}}})}const s=Object.entries(Object.getOwnPropertyDescriptors(e.prototype));for(const[e,i]of s)if(e.startsWith("$")&&void 0!==i.get){const s=`__${e}`;Object.defineProperties(t,{[s]:{value:new P(i.get.bind(t),s)},[e]:{get(){return this[s].get(r.getCurrentResponder())}}})}}class O{connect(){D(this,this.constructor)}$AutoRun(t){this.disposers.push(i(t))}$Reaction(t,e){this.disposers.push(o(t,e))}disposeReactions(){for(const t of this.disposers)t();this.disposers=[]}constructor(){this.disposers=[]}}class I extends S{mount(){D(this,this.constructor),this.update(),u.componentDidMountStack.push(this._ref)}run(){null!==this._ref.current&&(this.update(),u.componentDidUpdateStack.push(this._ref))}update(){r.pushResponder(this),super.update(),r.popResponder()}remove(){this._ref.current=null;for(const t of this.disposers)t();this.disposers=[],super.remove()}$AutoRun(t){this.disposers.push(i(t))}$Reaction(t,e){this.disposers.push(o(t,e))}constructor(...e){super(...e),this.responderType=t.component,this.ordered=!0,this.disposers=[]}}function L(t,...e){if(1===t.length)return t[0];let s="";for(let i=0;i<t.length;i++)e[i]&&(s+=t[i]);return s.trim()}function N(t){return e=>({elementType:p.host,_type:t,namespace:d.svg,props:e})}var F;N("svg"),N("polyline"),N("polygon"),N("circle"),N("title"),N("g");class E extends I{render(){const{$size:{width:t,height:e}}=this.props.uiStore;return z({ref:this.ref,className:L`Stage`,width:t,height:e})}componentDidMount(){const{current:t}=this.ref;t&&(this.context=t.getContext("2d"),this.gameLoop()),addEventListener("resize",(()=>{const{innerWidth:t,innerHeight:e}=window,{uiStore:s,store:{camera:i}}=this.props;s.$size={width:t,height:e},i.width=t,i.height=e}))}constructor(...t){super(...t),this.ref={current:null},this.context=null,this.timeOfLastFrame=Date.now(),this.gameLoop=()=>{this.gameLoop.name;const{context:t}=this;if(!t)return;const e=Date.now(),{gameObjects:s,gameObjects:{stats:i},camera:n}=this.props.store,o=e-this.timeOfLastFrame;s.update(o,n),n.update(),s.draw(t,n),requestAnimationFrame(this.gameLoop),i.addFrameDuration(Date.now()-e),this.timeOfLastFrame=e,this.gameLoop.name}}}class U extends I{render(){const{$showingConverse:t,$prompt:e}=this;return A({className:"Converse",children:[R({children:[t?"Hide hud":"Show hud"],className:"Converse-showButton",onclick:this.onClickShow}),t?this.drawConverseControls(e[this.$currentPrompt]):null]})}drawConverseControls(t){return A({className:"Converse-controls",children:[A({children:[t.npcText]}),A({className:L`Converse-options`,children:t.playerResponses.map(this.drawOption)})]})}constructor(...t){super(...t),this.$showingConverse=!1,this.$currentPrompt=0,this.$prompt=[{npcText:"0: Are you feeling lucky?",playerResponses:[{text:"yes",next:1},{text:"no",next:1},{text:"leave me alone",next:0}]},{npcText:"That will do you little good",playerResponses:[{text:"yes",next:0},{text:"no",next:0},{text:"leave me alone",next:0}]}],this.drawOption=t=>R({children:[t.text],onclick:()=>{this.$currentPrompt=t.next}}),this.onClickShow=()=>{this.$showingConverse=!this.$showingConverse}}}class W extends I{render(){return A({className:L`Hud`,children:[this.drawShootButton(),U.$({})],oncontextmenu:this.onContextMenu})}drawShootButton(){return this.props.uiStore.touchDevice?R({className:L`Hud-shootButton`,onclick:this.onClickShoot,children:["Shoot"]}):null}constructor(...t){super(...t),this.onClickShoot=t=>{t.preventDefault(),t.stopPropagation(),this.props.store.gameObjects.player.weapon.shoot()},this.onContextMenu=t=>{t.preventDefault()}}}class H extends O{constructor(){super(),this.touchDevice="ontouchstart"in window||navigator.maxTouchPoints>0,this.$size={width:window.innerWidth,height:window.innerHeight},super.connect()}}!function(t){function e(t,e){return Math.sqrt(t**2+e**2)}t.empty=[0,0],t.normalise=function(t){const[e,s]=t,i=Math.sqrt(e**2+s**2);if(0===i)return t;const n=1/i;return[e*n,s*n]},t.limitMagnitude=function(t,e){const[s,i]=t,n=Math.sqrt(s**2+i**2);if(n<e)return t;const o=e/n;return[s*o,i*o]},t.magnitude=e,t.magnitude2=function([t,e]){return Math.sqrt(t**2+e**2)},t.add=function(t,e){return[t[0]+e[0],t[1]+e[1]]},t.subtract=function(t,e){return[t[0]-e[0],t[1]-e[1]]},t.reverse=function([t,e]){return[-t,-e]},t.angle=function([t,e]){return Math.atan2(e,t)+90*Math.PI/180},t.scale=function([t,e],s){return[t*s,e*s]},t.rotate=function([t,e],s){const i=Math.sin(s),n=Math.cos(s);return[n*t-i*e,i*t+n*e]},t.distance=function(t,s){return e(s[0]-t[0],s[1]-t[1])}}(F||(F={}));class B{nextInt(){return this.seed=48271*this.seed%2147483647}next(){return(this.nextInt()-1)/2147483646}constructor(t){this.seed=t,(this.seed=(0|t)%2147483647)<=0&&(this.seed+=2147483646)}}const q=new B(0);function V(t,e){return[J(t[0]-e[0]),J(t[1]+e[1])]}function J(t){return t<0?t%1+1:t%1}var X;!function(t){t[t.weapon=0]="weapon",t[t.player=1]="player",t[t.object=2]="object",t[t.visual=3]="visual",t[t.enemy=4]="enemy"}(X||(X={}));let Y=0;function G(){const t=Y;return Y++,t}const K=1e8;function Q(t){return[Math.floor(t/K),t%K]}class Z{draw(t,e){const{width:s,height:i}=e;this.drawBackground(t,s,i);const{id:n}=this.store.gameObjects.player,o=this.store.movers.get(n);o&&this.drawStars(t,s,i,o)}drawBackground(t,e,s){t.fillStyle="rgb(0, 0, 0)",t.fillRect(0,0,e,s)}drawStars(t,e,s,i){const{position:[n,o]}=i,r=n/1e4%1e4,c=o/1e4%1e4;for(const{v:[i,n],size:o,colour:h}of function(t,e){return t.map((({v:t,size:s,colour:i})=>({v:V(t,e),size:s,colour:i})))}(this.stars,[r,-c])){const r=i*e,c=n*s;t.beginPath(),t.fillStyle=h,t.arc(r,c,5*o,0,2*Math.PI),t.fill()}}update(t,e){}constructor(t){this.store=t,this.id=G(),this.stars=function(t){const e=[],s=new B(0),i=()=>s.next();for(let s=0;s<t;s++)e.push({v:[i(),i()],size:i(),colour:`hsl(${Math.round(255*i())}, ${Math.round(20*i())}%, ${Math.round(100*i())}%)`});return e}(60),this.type=X.visual}}class tt{get center(){const{position:[t,e],size:[s,i]}=this;return[t+s/2,e+i/2]}get radius(){const{size:[t,e]}=this;return(t+e)/4}constructor(t=F.empty,e=F.empty,s=F.empty,i=F.empty,n=F.empty,o=0,r=1,c=10,h=!0){this.position=t,this.size=e,this.direction=s,this.velocity=i,this.thrust=n,this.rotation=o,this.mass=r,this.maxVelocity=c,this.visible=h,this.id=G()}}function et(t,e,s){if(0!==t.rotation){const s=e/1e3*t.rotation;t.direction=F.normalise(F.rotate(t.direction,s))}0===t.thrust[0]&&0===t.thrust[1]||(t.velocity=F.limitMagnitude(F.add(t.velocity,F.scale(t.thrust,e/100)),t.maxVelocity)),t.position=st(t,e),t.visible=function([t,e],[s,i],n){const{width:o,height:r,shift:[c,h]}=n,a=300;return t>-c-a&&t<-c+o+a&&e>-h-a&&e<-h+r+a}(t.position,t.size,s)}function st({position:t,velocity:e},s){const i=F.scale(e,s/16);return F.add(t,i)}class it{update(t,e){this.thrust=e;for(const e of this.particles)e.position[1]=(e.position[1]+.05*t)%this.height}draw(t,e){const{parent:{position:[s,i]},pos:[n,o],thrust:r}=this,{shift:[c,h]}=e;for(const e of this.particles){let[a,u]=e.position;u*=r,t.fillStyle=`rgba(256, 256, 150, ${1/(.5*u)})`;let l=u>4?a/(u/4):a;t.fillRect(s+c+n+l,i+h+o+u,2*(.1+r),2*(.1+r))}}constructor(t,e,s,i){this.pos=t,this.width=e,this.height=s,this.parent=i,this.particles=[],this.thrust=1;const n=new B(0);for(let t=0;t<40;t++){const t=n.next()*s,i=(n.next()-.5)*e;this.particles.push({colour:"#ffff7755",position:[i,t]})}}}const nt=new class{enable(t){this.enabled=t}draw(t,e,s){if(!this.enabled)return;const{shift:[i,n]}=s,{position:[o,r],size:[c,h],id:a}=e,u=o+i,l=r+n;t.lineWidth=1,t.strokeStyle="yellow",t.font="11px monospace",t.fillStyle="yellow",t.fillText(a.toString(),u,l-1),t.beginPath();const d=c/2,p=h/2;t.arc(u+d,l+p,(d+p)/2,0,2*Math.PI),t.stroke()}constructor(){this.enabled=!1}};class ot{draw(t,e){const{m:s}=this,{position:[i,n]}=s,{shift:[o,r]}=e;t.fillStyle=this.colour,t.beginPath(),t.arc(i+o,n+r,this.size/1.3,0,2*Math.PI),t.fill()}update(t,e){if(this.startedHitAnimation){this.hitAnimationTimeLeft-=t;const{hitAnimationTimeLeft:e}=this;e<=0?this.store.gameObjects.delete(this.id):this.size=Math.min(400/e,this.maxSize)}this.m.visible||this.store.gameObjects.delete(this.id)}hit(t){t.type!==X.visual&&t.id!==this.originId&&(this.startedHitAnimation=!0,this.hitAnimationTimeLeft=100,this.m.velocity=F.empty,this.m.size=F.empty,t.health-=this.damage,t.health<=0&&this.store.gameObjects.delete(t.id))}constructor(t,e,s,i){this.store=t,this.origin=e,this.originId=s,this.type=X.weapon,this.damage=7,this.health=1,this.startedHitAnimation=!1,this.hitAnimationTimeLeft=0,this.size=4,this.maxSize=2+10*Math.random(),this.colour="rgb(255,200,0)";const{movers:n,gameObjects:o}=t;let r=e.center;if("left"===i){const t=F.angle(e.direction);r=F.add(r,F.rotate([-10,-6],t))}else{const t=F.angle(e.direction);r=F.add(r,F.rotate([10,-6],t))}this.m=new tt(r,[this.size,this.size],e.direction,F.add(e.velocity,F.scale(e.direction,ot.velocity)),F.empty,0,.05,100),this.id=this.m.id,n.add(this.m),o.add(this)}}ot.velocity=10;class rt{update(t){this.lastShot+=t,this.shooting&&this.lastShot>this.timeBetweenShots&&this.shoot()}startShooting(){this.shooting=!0}stopShooting(){this.shooting=!1}shoot(){new ot(this.store,this.origin,this.originId,"left"),new ot(this.store,this.origin,this.originId,"right"),this.lastShot=0}constructor(t,e,s){this.store=t,this.origin=e,this.originId=s,this.shooting=!1,this.lastShot=0,this.timeBetweenShots=100}}class ct{update(t){const{controls:{thrust:e,rotation:s,back:i,mouseControls:n}}=this.store;n.update(),this.weapon.update(t);const{movers:o}=this.store,r=o.get(this.id);r&&(r.rotation=s,e>0?(this.thruster.update(t,e),r.thrust=F.scale(r.direction,e/1.5)):r.thrust=F.empty,i&&(r.velocity=F.empty))}draw(t,e){const{m:s}=this;if(!s)return;const{position:[i,n],size:[o,r]}=s,{shift:[c,h]}=e,a=F.angle(s.direction),u=o/2,l=r/2,d=c+i,p=h+n;t.save(),t.translate(d+u,p+l),t.rotate(a),t.translate(-d-u,-p-l),t.drawImage(this.shipImage,d,p,o,r),this.store.controls.thrust>0&&this.thruster.draw(t,e),t.restore(),nt.draw(t,s,e)}resetPosition(){const{movers:t}=this.store,e=t.get(this.id);e&&(e.position=F.empty,e.velocity=F.empty)}constructor(t){this.store=t,this.type=X.player,this.health=1e3,this.shipImage=document.createElement("img"),this.shipImage.src=s(2);const{movers:e}=t;this.m=new tt(F.empty,[40,40],[0,-1]),this.m.mass=5,this.id=this.m.id,e.add(this.m),this.weapon=new rt(t,this.m,this.id),this.thruster=new it(F.add(this.m.position,[19,38]),8,10,this.m)}}class ht{calcStats(){const{movers:t,gameObjects:{player:{id:e}}}=this.store,s=t.get(e);if(!s)return;const{position:i,direction:n,velocity:o}=s,r=t=>t.toPrecision(4);return[`${this.getFps()} fps (${this.getAvFrame().toPrecision(2)}ms/f)`,`pos (${r(i[0])}, ${r(i[1])})`,`dir (${n[0].toFixed(2)}, ${n[1].toFixed(2)})`,`vel (${o?.[0].toFixed(1)??0}, ${o?.[1].toFixed(1)??0})`]}draw(t,e){t.font="14px monospace",t.fillStyle="yellow",this.calcStats()?.forEach(((e,s)=>{t.fillText(e,8,22*(s+1))}))}update(t){this.fps.push(t),this.fps.length>10&&this.fps.shift()}getFps(){const t=this.fps.reduce(((t,e)=>t+e),0)/this.fps.length;return Math.min(Math.round(1e3/t),60)}addFrameDuration(t){this.frameDurations.push(t),this.frameDurations.length>100&&this.frameDurations.shift()}getAvFrame(){return this.frameDurations.reduce(((t,e)=>t+e),0)/this.frameDurations.length}constructor(t){this.store=t,this.id=G(),this.type=X.visual,this.fps=[],this.frameDurations=[]}}class at{generatePoints(){const{size:t}=this;for(let e=0;e<13;e++){const s=q.next()-.5,i=q.next()-.5,n=F.scale(F.rotate([.25*s,1+.25*i],2*Math.PI/13*e),t/2.2);n[0]+=.03,n[1]+=.03,this.points.push(n)}}drawToCanvasAndCreateBitMap(){const{cache:t,size:e}=this;if(!t)return;const{ctx:s}=t;if(!s)return;const i=e/2;this.drawAsteroid(s,i,i),t.cached=!0}drawAsteroid(t,e,s){const i=t.createRadialGradient(e,s,this.size/20,e,s,this.size/2);i.addColorStop(0,"#7e7e7e"),i.addColorStop(.9,"#5d5d5d"),t.fillStyle=i,t.strokeStyle="#5d5d5d",t.lineWidth=4,t.beginPath();const n=this.points[0];t.moveTo(e+n[0],s+n[1]);for(const i of this.points)t.lineTo(e+i[0],s+i[1]);t.lineTo(e+n[0],s+n[1]),t.stroke(),t.fill()}drawCached(t,e,s){if(this.cache&&(this.cache.cached||this.drawToCanvasAndCreateBitMap(),this.cache.cached)){const{position:[i,n]}=s,{shift:[o,r]}=e;t.drawImage(this.cache.canvas,i+o,n+r),nt.draw(t,s,e)}}draw(t,e){const{movers:s}=this.store,i=s.get(this.id);i&&i.visible&&this.drawUnCached(t,e,i)}drawUnCached(t,e,s){const{position:[i,n]}=s,{shift:[o,r]}=e,c=this.size/2;this.drawAsteroid(t,i+o+c,n+r+c),nt.draw(t,s,e)}update(t,e){}constructor(t,e=20,s){this.store=t,this.size=e,this.points=[],this.type=X.object,this.health=this.size,this.cache=null;const{movers:i}=t,n=new tt(s,[e,e]);n.mass=(e/10)**1.6,this.id=n.id,i.add(n),this.generatePoints()}}function ut(t,e){const{size:s,velocity:i,position:n}=t,[o,r]=n,[c,h]=s,a=F.subtract(e,[o+c/2,r+h/2]);if(F.magnitude2(a)<50)return t.thrust=F.empty,0;const u=F.limitMagnitude(a,10),l=F.subtract(u,i);return t.direction=F.normalise(l),t.thrust=F.scale(t.direction,1/1.5),1}class lt{draw(t,e){const{m:s}=this;if(!s)return;const{position:[i,n],size:[o,r]}=s,{shift:[c,h]}=e,a=F.angle(s.direction),u=o/2,l=r/2,d=c+i,p=h+n;t.save(),t.translate(d+u,p+l),t.rotate(a),t.translate(-d-u,-p-l),t.filter="invert(1) contrast(0.8) brightness(1.5)",t.drawImage(this.shipImage,d,p,o,r),t.restore(),nt.draw(t,s,e)}update(t,e){const{m:s,health:i}=this.store.gameObjects.player,{m:n}=this;this.weapon.update(t);const o=F.distance(s.position,n.position);if(i<=0)this.weapon.stopShooting();else if(o<200)if(function(t,e){const s=F.subtract(e.velocity,t.velocity);return F.magnitude2(s)<2}(n,s)){const t=st(s,o/ot.velocity);n.direction=F.limitMagnitude(F.subtract(t,n.position),1),this.weapon.startShooting()}else!function(t,e){const s=F.subtract(e.velocity,t.velocity);t.direction=F.normalise(s),t.thrust=F.scale(t.direction,1/1.5)}(n,s),this.weapon.stopShooting();else if(o<400){const t=st(s,o/ot.velocity);n.direction=F.limitMagnitude(F.subtract(t,n.position),1),this.weapon.startShooting()}else o<8e3?(this.weapon.stopShooting(),function(t,e){let s;s=F.magnitude2(e.velocity)<1?e.position:st(e,F.distance(e.position,t.position)/F.magnitude2(e.velocity)),ut(t,s)}(n,s)):this.weapon.stopShooting()}constructor(t,e){this.store=t,this.health=100,this.type=X.enemy,this.shipImage=document.createElement("img");const{movers:i}=t;this.m=new tt(e,[40,40],[1,0]),this.m.mass=5,this.id=this.m.id,i.add(this.m),this.weapon=new rt(t,this.m,this.id),this.shipImage.src=s(2)}}class dt{draw(t,e){const{targetPos:s}=this.store;if(!s)return;const[i,n]=s,[o,r]=e.shift;t.beginPath(),t.fillStyle="#00ff00cc",t.arc(i+o,n+r,7,0,2*Math.PI),t.fill()}constructor(t){this.store=t}}class pt{add(t){this.objects.set(t.id,t)}update(t,e){this.store.movers.update(t,e);for(const s of this.objects.values())s.update(t,e)}draw(t,e){for(const s of this.objects.values())s.draw(t,e);this.targetLocation.draw(t,e)}delete(t){this.store.movers.delete(t),this.objects.delete(t)}constructor(t){this.store=t,this.targetLocation=new dt(this.store),this.objects=new Map,this.player=new ct(this.store),this.stats=new ht(this.store),this.add(new Z(t)),function(t,e){const s=9e3;for(let i=0;i<5e3;i++){const i=new at(t,5+60*q.next(),[-s/2+q.next()*s,-s/2+q.next()*s]);e.add(i)}}(t,this),this.add(new lt(t,[300,600])),this.add(new lt(t,[400,100])),this.add(new lt(t,[200,-600])),this.add(new lt(t,[-500,200])),this.add(this.player),this.add(this.stats)}}class mt{update(){const{targetPos:t}=this.store;if(!t)return;const{gameObjects:e}=this.store,s=ut(e.player.m,t);this.controls.thrust=s,0===s&&(this.store.targetPos=null)}setTargetPosition(t,e){const{shift:[s,i]}=this.store.camera;this.store.targetPos=[t-s,e-i]}constructor(t,e){this.store=t,this.controls=e,this.onMove=t=>{if(t.currentTarget instanceof Window){const{clientX:e,clientY:s}=t;this.setTargetPosition(e,s)}},this.onUp=()=>{removeEventListener("pointermove",this.onMove),this.controls.rotation=0,this.controls.thrust=0},addEventListener("pointerdown",(t=>{if(t.currentTarget instanceof Window){const{clientX:e,clientY:s}=t;this.setTargetPosition(e,s),addEventListener("pointermove",this.onMove),addEventListener("pointerup",this.onUp,{once:!0}),addEventListener("pointerout",this.onUp,{once:!0})}}))}}class ft{constructor(t){this.store=t,this.thrust=0,this.back=!1,this.rotation=0,this.mouseControls=new mt(this.store,this),addEventListener("keydown",(t=>{switch(t.key){case"p":this.store.paused=!this.store.paused;break;case"b":nt.enable(!nt.enabled);break;case"w":case"ArrowUp":this.thrust=.9,this.store.targetPos=null;break;case"s":case"ArrowDown":this.back=!0,this.store.targetPos=null;break;case"a":case"ArrowLeft":this.rotation=-4,this.store.targetPos=null;break;case"d":case"ArrowRight":this.rotation=4,this.store.targetPos=null;break;case" ":this.store.gameObjects.player.weapon.startShooting()}})),addEventListener("keyup",(t=>{switch(t.key){case"r":this.store.gameObjects.player.resetPosition();break;case"p":break;case"w":case"ArrowUp":this.thrust=0;break;case"s":case"ArrowDown":this.back=!1;break;case"a":case"ArrowLeft":case"d":case"ArrowRight":this.rotation=0;break;case" ":this.store.gameObjects.player.weapon.stopShooting()}}))}}function gt(t,e,s){const i=s.get(t),n=s.get(e);if(i&&n)return F.distance(i.center,n.center)<=i.radius+n.radius}function vt(t,e,s){const i=s.get(t),n=s.get(e);if(!i||!n)return;const{center:o,velocity:r,mass:c}=i,{center:h,velocity:a,mass:u}=n,l=F.subtract(h,o),d=F.distance(h,o),p=[l[0]/d,l[1]/d],m=[r[0]-a[0],r[1]-a[1]],f=m[0]*p[0]+m[1]*p[1];if(f<0)return;const g=2*f/(c+u);i.velocity=[r[0]-g*u*p[0],r[1]-g*u*p[1]],n.velocity=[a[0]+g*c*p[0],a[1]+g*c*p[1]]}function wt(t,e,[s,i],[n,o]){wt.name;const r=function(t,e,s,i){const n=bt(t,e,10),{length:o}=n;if(0===o)return n;const r=-t;t+=r,e+=r;for(const{position:s,size:[o],id:c,visible:h}of i.values()){if(!h)continue;const i=s[0]+r;for(let s=i;s<i+o;s+=10)s>=t&&s<=e&&n[Math.floor(s/10)].push(c)}return n.length,JSON.stringify(n),n}(s,n,0,e),c=function(t,e,s,i){const n=bt(t,e,10),{length:o}=n;if(0===o)return n;const r=-t;t+=r,e+=r;for(const{position:s,size:o,id:c,visible:h}of i.values()){if(!h)continue;const i=o[1],a=s[1]+r;for(let s=a;s<a+i;s+=10)s>=t&&s<=e&&n[Math.floor(s/10)].push(c)}return n.length,JSON.stringify(n),n}(i,o,0,e),h=function(t,e){t=t.filter((t=>t.length>1)),e=e.filter((t=>t.length>1));const s=new Set;for(const e of t)for(const t of yt(e))s.add(t);const i=new Set;for(const t of e)for(const e of yt(t))s.has(e)&&i.add(e);const n=[];for(const t of i.values())n.push(Q(t));return n}(r,c);wt.name;const{gameObjects:a}=t;for(const[t,s]of h){if(!gt(t,s,e))continue;const i=a.objects.get(t),n=a.objects.get(s);i&&n&&(vt(t,s,e),i.type===X.weapon?i.hit(n):n.type===X.weapon&&n.hit(i))}}function yt(t){const e=[];for(let s=0;s<t.length;s++){const i=t[s];for(let n=s+1;n<t.length;n++){const s=t[n];e.push(i*K+s)}}return e}function bt(t,e,s){const i=e-t,n=Math.ceil(i/s),o=[];for(let t=0;t<n;t++)o.push([]);return o}class St{update(t,e){for(const s of this.map.values())et(s,t,e);const{points:[s,i]}=e;wt(e.store,this.map,s,i)}add(t){this.map.set(t.id,t)}get(t){return this.map.get(t)}delete(t){this.map.delete(t)}constructor(){this.map=new Map}}class kt{update(){const{width:t,height:e,store:s}=this,{movers:i}=s,{id:n}=this.store.gameObjects.player,o=i.get(n);if(!o)return;const{position:[r,c],size:[h,a]}=o,u=t/2,l=e/2;this.shift=[-r+u-h/2,-c+l-a/2],this.points=[[r-u,c-l],[r+u,c+l]]}constructor(t,e,s){this.store=t,this.width=e,this.height=s,this.scale=1,this.shift=F.empty,this.points=[F.empty,F.empty]}}class xt{constructor(t,e){this.targetPos=null,this.paused=!1,this.movers=new St,this.gameObjects=new pt(this),this.controls=new ft(this),this.camera=new kt(this,t,e)}}var Ct,Mt;Ct=class extends I{render(){const{uiStore:t,store:e}=this;return A({className:L`Main`,children:[E.$({uiStore:t,store:e}),W.$({uiStore:t,store:e})]})}constructor(...t){super(...t),this.uiStore=new H,this.store=new xt(this.uiStore.$size.width,this.uiStore.$size.height)}}.$({}),Mt=document.getElementById("root"),null===Ct?C.clear():C.render(Ct,Mt)})()})();